{% extends 'parent/base.html' %}
{% load static %}

{% block title %}products{% endblock %}

{% block content %}
    <div class="header">
        <h1>Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯</h1>
    </div>

    <div class="cart-content">
        {% for item in cart %}
            {# item = product-info(dictionary) #}
            {% with product=item.product %}
                <div class="product-item" data-item-id="{{ product.id }}">
                    <a href="{% url 'shop:product_detail' product.id product.slug %}">
                        <img src="{{ product.images.first.file.url }}" alt="{{ product.images.first.file }}">
                    </a>

                    <div class="product-info">
                        <h3>
                            <a href="{% url 'shop:product_detail' product.id product.slug %}">
                                Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„: {{ product.name }}
                            </a>
                        </h3>

                        <p>ØªØ¹Ø¯Ø§Ø¯: <span class="quantity" id="quantity-{{ product.id }}">{{ item.quantity }}</span></p>
                        <p>Ù‚ÛŒÙ…Øª: <span class="price">{{ item.price }}</span></p>
                        <p>Ù…Ø¬Ù…ÙˆØ¹ Ù‚ÛŒÙ…Øª: <span class="product-total-price" id="product-price-{{ product.id }}">{{ item.total }}</span></p>
                    </div>

                    <div class="actions">
                        <button class="quantity-decrease">-</button>
                        <button class="quantity-add">+</button>
                        <span class="delete">ğŸ—‘ï¸</span>
                    </div>
                </div>
            {% endwith %}
            {% if not forloop.last %}
                <hr>
            {% endif %}
        {% empty %}
            Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª!
        {% endfor %}

        <div class="cart-total-price">
            <p>Ù‚ÛŒÙ…Øª Ú©Ù„ Ù…Ø­ØµÙˆÙ„Ø§Øª: <span id="total-price">{{ cart.get_total_price }}</span> ØªÙˆÙ…Ø§Ù†</p>
            <p>Ù‡Ø²ÛŒÙ†Ù‡ Ù¾Ø³ØªÛŒ: <span class="post-price">{{ cart.get_post_price }}</span> ØªÙˆÙ…Ø§Ù†</p>
            <p>Ù‡Ø²ÛŒÙ†Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: <span class="final-price">{{ cart.get_final_price }}</span> ØªÙˆÙ…Ø§Ù†</p>
        </div>

        <div class="checkout-button">
            <div class="continue-btn"><a href="#">Ø§Ø¯Ø§Ù…Ù‡ Ø®Ø±ÛŒØ¯</a></div>
            <div class="back-btn"><a href="{% url 'shop:product_list' %}">Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª</a></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        $(document).ready(function (){
            $('.quantity-add').click(function (){
                updateQuantity('add', $(this).closest('.product-item').data('item-id'));
            });

            $('.quantity-decrease').click(function (){
                updateQuantity('decrease', $(this).closest('.product-item').data('item-id'));
            });
            $('.delete').click(function (){
                deleteProduct($(this).closest('.product-item').data('item-id'));
            });


            // {# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” update-quantity function â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” #}
            function updateQuantity(action, productId) {
                $.ajax({
                    type: 'POST',
                    url: '{% url "cart:update_quantity" %}',
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'action': action,
                        'product_id': productId,
                    },

                    success: function (response){
                        if(response.success){
                            // {# Ø¨Ø®Ø´ Ø¨Ø§Ù„Ø§ÛŒÛŒ(header) #}
                            $('.item-count').text(response.item_count);
                            $('.total-price').text(response.total_price);
                            // {# ØªØ¹Ø¯Ø§Ø¯ Ùˆ Ù…Ø¬Ù…ÙˆØ¹ Ù‚ÛŒÙ…Øª Ú©Ø§Ù„Ø§ #}
                            $('#quantity-' + productId).text(response.quantity);
                            $('#product-price-' + productId).text(response.product_cost);
                            // {# Ù‚ÛŒÙ…Øª Ú©Ù„ Ù…Ø­ØµÙˆÙ„Ø§ØªØŒ Ù‡Ø²ÛŒÙ†Ù‡ Ù¾Ø³ØªÛŒ Ùˆ Ù‡Ø²ÛŒÙ†Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª #}
                            $('#total-price').text(response.total_price);
                            // $('.post-price').text(response.post_price);
                            $('.final-price').text(response.final_price);

                        }else{
                            alert("Error update quantity!!!");
                        }
                    }
                });
            }
              // {# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” delete-product function â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” #}
            function deleteProduct(productId) {
                $.ajax({
                    type: 'POST',
                    url: '{% url "cart:delete_product" %}',
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'product_id': productId,
                    },

                    success: function (response){
                        if(response.success){
                            // {# Ø¨Ø®Ø´ Ø¨Ø§Ù„Ø§ÛŒÛŒ(header) #}
                            $('.item-count').text(response.item_count);
                            $('.total-price').text(response.total_price);
                            // {# Ù‚ÛŒÙ…Øª Ú©Ù„ Ù…Ø­ØµÙˆÙ„Ø§ØªØŒ Ù‡Ø²ÛŒÙ†Ù‡ Ù¾Ø³ØªÛŒ Ùˆ Ù‡Ø²ÛŒÙ†Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª #}
                            $('#total-price').text(response.total_price);
                            $('.post-price').text(response.post_price);
                            $('.final-price').text(response.final_price);
                            // {# Ø­Ø°Ù Ú©Ø§Ù„Ø§ Ø§Ø² Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ #}
                            $(`.product-item[data-item-id=${ productId }]`).remove();
                        }else{
                            alert("Error update quantity!!!");
                        }
                    }
                });
            }

        });
    </script>
{% endblock %}
